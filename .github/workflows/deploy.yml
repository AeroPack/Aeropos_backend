name: Deploy with Docker Compose

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Copy all necessary source files to the VPS
      # The Dockerfile uses COPY . . so src/, package.json, tsconfig.json etc. are all needed
      - name: Copy Files to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docker-compose.yml,Dockerfile,package.json,package-lock.json,tsconfig.json,src/"
          target: "~/my-new-app"

      # Write the .env file on the VPS from GitHub Secrets (never commit .env to git)
      - name: Create .env file on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            mkdir -p ~/my-new-app
            cat > ~/my-new-app/.env << 'EOF'
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            EMAIL_HOST=${{ secrets.EMAIL_HOST }}
            EMAIL_PORT=${{ secrets.EMAIL_PORT }}
            EMAIL_SECURE=${{ secrets.EMAIL_SECURE }}
            EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}
            EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            EOF

      # SSH into VPS and bring up the containers
      - name: SSH and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/my-new-app

            # Pull latest images (if any from registry)
            docker compose pull || true

            # Rebuild and restart containers
            docker compose up -d --build

            # Clean up unused images to save disk space
            docker image prune -f

            echo "âœ… Deployment complete!"
